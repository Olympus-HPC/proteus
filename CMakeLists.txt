cmake_minimum_required(VERSION 3.18)

project(ApolloJIT
  VERSION 0.1.0
  LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 17 CACHE STRING "")
set(CMAKE_CXX_STANDARD_REQUIRED YES)
set(CMAKE_CXX_EXTENSIONS NO)
option(ENABLE_HIP "Enable HIP" OFF)
option(ENABLE_CUDA "Enable CUDA" OFF)
option(ENABLE_DEBUG "Enable debugging output" OFF)
option(ENABLE_RUNTIME_CONSTPROP "Enable runtime constant propagation through JIT" ON)
option(ENABLE_JIT_LAUNCH_BOUNDS "Enable runtime launch bounds setting through JIT" ON)
option(ENABLE_TIME_TRACING "Enable time tracing for the JIT engine" OFF)
option(BUILD_SHARED_LIBJIT "Builds the JIT library as shared" OFF)
option(ENABLE_TESTS "Enable tests" ON)
option(ENABLE_LLVMIR_STORED_CACHE "Use LLVM IR for the stored cache" OFF)
option(ENABLE_CUDA_PTX_STORED_CACHE "Use PTX for the CUDA stored cache" OFF)

set(LLVM_VERSION "17" CACHE STRING "LLVM version")

if(ENABLE_LLVMIR_STORED_CACHE)
  message(FATAL_ERROR "LLVM IR in stored cache is not supported yet")
  add_definitions("-DENABLE_LLVMIR_STORED_CACHE")
endif()

if(ENABLE_HIP)
  add_definitions("-DENABLE_HIP")
  find_package(hip 5.7.1 REQUIRED CONFIG)
endif()

if(ENABLE_CUDA)
  add_definitions("-DENABLE_CUDA")

  if(ENABLE_CUDA_PTX_STORED_CACHE)
    add_definitions("-DENABLE_CUDA_PTX_STORED_CACHE")
  endif()

  find_package(CUDAToolkit REQUIRED)
endif()

if(ENABLE_DEBUG)
  add_definitions("-DENABLE_DEBUG")
endif()

include(cmake/SetupLLVM.cmake)

add_subdirectory(lib)
add_subdirectory(pass)

if(ENABLE_TESTS)
  enable_testing()
  add_subdirectory(tests)
endif()
