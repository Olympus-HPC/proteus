###############################################################################
# Copyright (c) 2022-25, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
###############################################################################

# The template job to test whether a machine is up.
# Expects CI_MACHINE defined to machine name.
.machine-check:
  stage: prerequisites
  tags: [shell, oslic]
  variables:
    GIT_STRATEGY: none
  script:
    - |
      # Check if required variables are set for machine checking
      if [ -z "$CI_MACHINE" ]; then
        echo -e "\e[31mError: CI_MACHINE variable not set\e[0m"
        exit 1
      fi

      # Check if lorenz status file exists
      LORENZ_STATUS_FILE="/usr/global/tools/lorenz/data/loginnodeStatus"
      if [ ! -f "$LORENZ_STATUS_FILE" ]; then
        echo -e "\e[31mError: Lorenz status file not found: $LORENZ_STATUS_FILE\e[0m"
        exit 1
      fi

      echo "Checking availability of machine: ${CI_MACHINE}"

      # Query machine status with error handling
      NODES_UP=$(jq -r ".[\"${CI_MACHINE}\"].total_nodes_up // \"null\"" "$LORENZ_STATUS_FILE" 2>/dev/null)
      JQ_EXIT_CODE=$?

      if [ $JQ_EXIT_CODE -ne 0 ]; then
        echo -e "\e[31mError: Failed to parse lorenz status file\e[0m"
        echo "File content sample:"
        head -n 5 "$LORENZ_STATUS_FILE" 2>/dev/null || echo "Cannot read file"
        exit 1
      fi

      if [ "$NODES_UP" = "null" ]; then
        echo -e "\e[31mError: Machine ${CI_MACHINE} not found in status file\e[0m"
        echo "Available machines in status file:"
        jq -r 'keys[]' "$LORENZ_STATUS_FILE" 2>/dev/null | head -10 || echo "Cannot list machines"
        exit 1
      fi

      # Check if machine is available - THIS is the only case we report to GitHub
      if [ "$NODES_UP" -eq 0 ]; then
        echo -e "\e[31mMachine ${CI_MACHINE} is down (${NODES_UP} nodes up)\e[0m"

        # Only report machine unavailability to GitHub
        if [ -n "$GITHUB_TOKEN" ] && [ -n "$GITHUB_PROJECT_ORG" ] && [ -n "$GITHUB_PROJECT_NAME" ]; then
          STATUS_RESPONSE=$(mktemp)
          STATUS_HTTP_CODE=$(curl --retry 3 --retry-delay 5 --max-time 30 \
              --url "https://api.github.com/repos/${GITHUB_PROJECT_ORG}/${GITHUB_PROJECT_NAME}/statuses/${CI_COMMIT_SHA}" \
              --header 'Content-Type: application/json' \
              --header "authorization: Bearer ${GITHUB_TOKEN}" \
              --data "{ \"state\": \"failure\", \"target_url\": \"${CI_PIPELINE_URL}\", \"description\": \"GitLab: ${CI_MACHINE} down (0 nodes)\", \"context\": \"ci/gitlab/${CI_MACHINE}\" }" \
              --output "$STATUS_RESPONSE" \
              --write-out "%{http_code}" \
              --silent \
              --show-error)

          echo "GitHub Status API response code: $STATUS_HTTP_CODE"

          if [ "$STATUS_HTTP_CODE" -eq 201 ]; then
            echo "Successfully reported machine down status to GitHub"
          else
            echo "Warning: Failed to report status to GitHub. HTTP status: $STATUS_HTTP_CODE"
            echo "Response body:"
            cat "$STATUS_RESPONSE"
          fi

          rm -f "$STATUS_RESPONSE"
        else
          echo "Warning: GitHub reporting variables not set, skipping GitHub status update"
        fi

        exit 1
      else
        echo -e "\e[32m${CI_MACHINE} is available (${NODES_UP} nodes up)\e[0m"
      fi

###
# Trigger a build-and-test pipeline for a machine.
# Comment the jobs for machines you donâ€™t need.
###

# MATRIX
matrix-up-check:
  variables:
    CI_MACHINE: "matrix"
  extends: [.machine-check]

matrix-build-and-test:
  variables:
    CI_MACHINE: "matrix"
  needs: [matrix-up-check]
  extends: [.build-and-test]

matrix-proteus-benchmarks:
  variables:
    CI_MACHINE: "matrix"
    JOB_CMD:
      value: "scripts/gitlab/ci-run-benchmarks.sh"
      expand: false
  needs: [matrix-up-check]
  extends: [.run-benchmarks]

# TIOGA
tioga-up-check:
  variables:
    CI_MACHINE: "tioga"
  extends: [.machine-check]

tioga-build-and-test:
  variables:
    CI_MACHINE: "tioga"
  needs: [tioga-up-check]
  extends: [.build-and-test-rocm]

tioga-test-integration:
  variables:
    CI_MACHINE: "tioga"
    JOB_CMD:
      value: "tests/integration/hip/ci-test-integration.sh"
      expand: false
  needs: [tioga-up-check]
  extends: [.test-integration]

tioga-proteus-benchmarks:
  variables:
    CI_MACHINE: "tioga"
    JOB_CMD:
      value: "scripts/gitlab/ci-run-benchmarks.sh"
      expand: false
  needs: [tioga-up-check]
  extends: [.run-benchmarks]

# TUOLUMNE
tuolumne-up-check:
  variables:
    CI_MACHINE: "tuolumne"
  extends: [.machine-check]

tuolumne-build-and-test:
  variables:
    CI_MACHINE: "tuolumne"
  needs: [tuolumne-up-check, generate-job-lists]
  extends: [.build-and-test]

tuolumne-test-integration:
  variables:
    CI_MACHINE: "tuolumne"
    JOB_CMD:
      value: "tests/integration/hip/ci-test-integration.sh"
      expand: false
  needs: [tuolumne-up-check]
  extends: [.test-integration]

tuolumne-proteus-benchmarks:
  variables:
    CI_MACHINE: "tuolumne"
    JOB_CMD:
      value: "scripts/gitlab/ci-run-benchmarks.sh"
      expand: false
  needs: [tuolumne-up-check]
  extends: [.run-benchmarks]
